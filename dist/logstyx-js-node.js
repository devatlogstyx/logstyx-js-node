var oe=Object.defineProperty,re=Object.defineProperties;var ae=Object.getOwnPropertyDescriptors;var N=Object.getOwnPropertySymbols;var le=Object.prototype.hasOwnProperty,ie=Object.prototype.propertyIsEnumerable;var D=(e,t,s)=>t in e?oe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,m=(e,t)=>{for(var s in t||(t={}))le.call(t,s)&&D(e,s,t[s]);if(N)for(var s of N(t))ie.call(t,s)&&D(e,s,t[s]);return e},P=(e,t)=>re(e,ae(t));var j=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var F=(e,t,s)=>new Promise((a,o)=>{var l=u=>{try{r(s.next(u))}catch(i){o(i)}},n=u=>{try{r(s.throw(u))}catch(i){o(i)}},r=u=>u.done?a(u.value):Promise.resolve(u.value).then(l,n);r((s=s.apply(e,t)).next())});var U=j(H=>{H.safeParse=e=>{try{return e?JSON.parse(e):{}}catch(t){return{}}};H.num2Int=e=>isNaN(e)?0:parseInt(e)});var W=j(z=>{var{num2Int:ue}=U(),ce=require("crypto");z.generateSignature=(e,t,s={})=>{let a=new Date().getTime(),o=JSON.stringify(s),l=e+o+ue(a),n=ce.createHmac("SHA256",t).update(l).digest("hex").toUpperCase();return{timestamp:a,signature:n}}});var K=j((He,G)=>{var de=Object.defineProperty,$=Object.getOwnPropertySymbols,ye=Object.prototype.hasOwnProperty,ge=Object.prototype.propertyIsEnumerable,J=(e,t,s)=>t in e?de(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,M=(e,t)=>{for(var s in t||(t={}))ye.call(t,s)&&J(e,s,t[s]);if($)for(var s of $(t))ge.call(t,s)&&J(e,s,t[s]);return e},B=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),Q=(e,t,s)=>new Promise((a,o)=>{var l=u=>{try{r(s.next(u))}catch(i){o(i)}},n=u=>{try{r(s.throw(u))}catch(i){o(i)}},r=u=>u.done?a(u.value):Promise.resolve(u.value).then(l,n);r((s=s.apply(e,t)).next())}),fe=B(e=>{e.sanitizeObject=t=>Object.entries(t).reduce((s,[a,o])=>(o!=null&&o!==""&&!(Array.isArray(o)&&o.length===0)&&!(typeof o=="object"&&!Array.isArray(o)&&Object.keys(o).length===0&&o.constructor===Object)&&(s[a]=o),s),{}),e.normalizeArgs=t=>{var s,a;let o=(l,n=0,r=new WeakSet)=>{if(l===null||typeof l!="object")return typeof l=="string"&&l.length>500?l.substring(0,500)+"... (truncated)":l;if(n>=2)return"[Max depth reached]";if(r.has(l))return"[Circular]";if(r.add(l),Array.isArray(l))return l.slice(0,10).map(i=>o(i,n+1,r));let u={};for(let i in l)i.startsWith("_")||Object.prototype.hasOwnProperty.call(l,i)&&typeof l[i]!="function"&&(u[i]=o(l[i],n+1,r));return u};if(t instanceof Error){let l={title:(a=t.name)!=null?a:(s=t==null?void 0:t.constructor)==null?void 0:s.name,message:t.message,stack:t.stack||null},n=new WeakSet;return Object.keys(t).forEach(r=>{!l[r]&&typeof t[r]!="function"&&(l[r]=o(t[r],0,n))}),l}return t==null?{message:String(t)}:Array.isArray(t)?{message:JSON.stringify(t)}:typeof t=="object"?t:{message:String(t)}}}),me=B(e=>{var{sanitizeObject:t,normalizeArgs:s}=fe();e.useLogstyx=a=>{let{projectId:o,apiKey:l,appid:n,endpoint:r,device:u,sendFunc:i,signatureFunc:p,maxLogInQueue:C=12,onError:k}=a;typeof i!="function"&&(i=fetch);let f=[],y=!1,h=0,d=null,b={appid:n};function R(c){b=M(M({},b),c)}function _(c){if(Array.isArray(c))for(let x of c)delete b[x];else b={}}function S(c,x){if(typeof k=="function")try{k(c,x)}catch(T){}}function I(){if(!(y||d)&&f.length>0){let c=Math.min(1e3*Math.pow(2,h),3e4);d=setTimeout(L,c)}}function L(){return Q(this,null,function*(){if(d&&(clearTimeout(d),d=null),!(y||f.length===0)){y=!0;try{let{level:c,data:x}=f[0];yield g(c,x,!0),f.shift(),h=0}catch(c){h++;let x=f.shift();f.push(x),S(c,{level:x.level,queueLength:f.length,consecutiveFailures:h})}finally{y=!1}I()}})}function g(c){return Q(this,arguments,function*(x,T={},te=!1){try{let O=t({level:x,projectId:o,appid:n,device:u,context:t(b),data:t(s(T))}),A={"Content-Type":"application/json"};if(typeof p=="function"){let{timestamp:se,signature:ne}=p(o,l,O);A.signature=ne,A.timestamp=se}return yield i(r,{method:"POST",body:JSON.stringify(O),headers:A})}catch(O){if(te)throw O;if(f.length>=C){let A=f.shift();S(new Error("Queue full, dropping oldest log"),{dropped:A})}f.push({level:x,data:T}),I()}})}return{info:c=>g("INFO",c),warning:c=>g("WARNING",c),error:c=>g("ERROR",c),critical:c=>g("CRITICAL",c),send:g,setContext:R,clearContext:_,getQueueLength:()=>f.length}}}),{useLogstyx:pe}=me();G.exports=e=>pe(e)});var q=j((Le,Z)=>{var X=require("module"),V=!1,E=null,w={};function Y(){if(V)return;let e=X.prototype.require;X.prototype.require=function(t){let s=e.apply(this,arguments);return E?t==="express"&&!s.__logstyx_instrumented?(s.__logstyx_instrumented=!0,we(s,w)):t==="fastify"&&!s.__logstyx_instrumented?(s.__logstyx_instrumented=!0,Ee(s,w)):s:s},V=!0,console.log("[Logstyx] Auto-instrumentation hook installed")}function he(e,t={}){E=e,w=m(P(m({},w),{ignorePaths:t.ignorePaths||w.ignorePaths||["/health","/metrics"],shouldIgnore:t.shouldIgnore||(()=>!1),slowRequestThreshold:t.slowRequestThreshold||w.slowRequestThreshold||1e3,redactFields:t.redactFields||w.redactFields||["password","token","authorization","secret","apikey","api_key"],buildRequestPayload:t.buildRequestPayload||w.buildRequestPayload||be,contextHook:t.contextHook||w.contextHook||null}),t),console.log("[Logstyx] Auto-instrumentation configured")}function xe(e={}){w=m(m({},w),e),console.log("[Logstyx] Auto-instrumentation config updated")}function we(e,t){let s=e;return function(){let o=s();o.use((n,r,u)=>{let i=Date.now(),p=!1;if(n._logstyxError=null,t.ignorePaths.some(d=>n.path.startsWith(d)))return u();let k=r.send,f=r.json,y=r.end;function h(d,b){var c;if(p)return;p=!0;let R=r.statusCode,_=Date.now()-i,S=Pe(n,t),I=_>t.slowRequestThreshold;if(r.isSlow=I,t.shouldIgnore(n,r))return;let g=P(m({title:`${n.method} ${n.originalUrl}`},S),{body:v(n.body,t.redactFields),response:d==="json"||d==="send"?v(b,t.redactFields):null,responseTime:_,statusCode:R,isSlow:I});n._logstyxError&&(g.error={message:n._logstyxError.message,stack:n._logstyxError.stack,name:n._logstyxError.name,code:n._logstyxError.code}),R>=500?(g.message=n._logstyxError?n._logstyxError.message:"Server error occurred",E.critical(g)):R>=400?(g.message=R===404?"Route not found":((c=n._logstyxError)==null?void 0:c.message)||"Client error",E.error(g)):_>t.slowRequestThreshold?(g.message=`Slow request detected (${_}ms)`,E.warning(g)):(g.message="Request completed successfully",E.info(g))}r.send=function(...d){return h("send",d[0]),k.apply(this,d)},r.json=function(...d){return h("json",d[0]),f.apply(this,d)},r.end=function(...d){return h("end",d[0]),y.apply(this,d)},u()});let l=o.listen;return o.listen=function(...n){return o.use((r,u,i,p)=>{u._logstyxError=r,(!i.statusCode||i.statusCode===200)&&(i.statusCode=r.status||r.statusCode||500),p(r)}),l.apply(this,n)},o}}function Ee(e,t){let s=e;return function(o){let l=s(o);return l.addHook("onRequest",(n,r)=>F(null,null,function*(){n._logstyxStartTime=Date.now(),n._logstyxError=null})),l.addHook("onError",(n,r,u)=>F(null,null,function*(){n._logstyxError=u})),l.addHook("onResponse",(n,r)=>F(null,null,function*(){var h;if(t.ignorePaths.some(d=>n.url.startsWith(d)))return;let i=Date.now()-n._logstyxStartTime,p=r.statusCode,C=i>t.slowRequestThreshold;if(r.isSlow=i,t.shouldIgnore(n,r))return;let f=ve(n,t),y=P(m({title:`${n.method} ${n.url}`},f),{responseTime:i,statusCode:p,isSlow:C,body:v(n.body,t.redactFields)});n._logstyxError&&(y.error={message:n._logstyxError.message,stack:n._logstyxError.stack,name:n._logstyxError.name,code:n._logstyxError.code}),p>=500?(y.message=n._logstyxError?n._logstyxError.message:"Server error occurred",E.critical(y)):p>=400?(y.message=p===404?"Route not found":((h=n._logstyxError)==null?void 0:h.message)||"Client error",E.error(y)):i>t.slowRequestThreshold?(y.message=`Slow request detected (${i}ms)`,E.warning(y)):(y.message="Request completed successfully",E.info(y))})),l}}function be(e){return{method:e.method,url:e.url,path:e.path,ip:e.ip,userAgent:e.get("User-Agent"),requestId:e.id||e.headers["x-request-id"],user:Re(e),admin:_e(e),session:e.session?{id:e.session.id}:null,query:e.query,params:e.params}}function Re(e){var a,o,l,n;return[e.user,(a=e.auth)==null?void 0:a.user,(o=e.session)==null?void 0:o.user,(l=e.locals)==null?void 0:l.user,(n=e.context)==null?void 0:n.user,e.currentUser,e.account,e.profile].find(r=>r&&(r.id||r.email||r.username))||null}function _e(e){var t,s;return e.admin||((t=e.user)!=null&&t.isAdmin?e.user:null)||((s=e.session)==null?void 0:s.admin)||null}function Pe(e,t){let s=t.buildRequestPayload(e);if(t.contextHook){let a=t.contextHook(e);s=m(m({},s),a)}return v(s,t.redactFields)}function ve(e,t){let s={method:e.method,url:e.url,path:e.url,ip:e.ip,headers:e.headers,id:e.id,query:e.query,params:e.params,body:e.body,session:e.session||null,user:e.user||null,get:o=>e.headers[o.toLowerCase()]},a=t.buildRequestPayload(s);if(t.contextHook){let o=t.contextHook(s);a=m(m({},a),o)}return v(a,t.redactFields)}function v(e,t){if(!e||typeof e!="object")return e;e.toObject&&typeof e.toObject=="function"&&(e=e.toObject());let s=Array.isArray(e)?[]:{};for(let[a,o]of Object.entries(e))t.some(l=>a.toLowerCase().includes(l.toLowerCase()))?s[a]="[REDACTED]":o!==null&&typeof o=="object"?s[a]=v(o,t):s[a]=o;return s}Y();Z.exports={configure:he,setupAutoInstrumentation:Y,updateConfig:xe}});var ee=require("os"),{generateSignature:ke}=W(),Ie=K(),{configure:Ae,setupAutoInstrumentation:Ce,updateConfig:Se}=q(),[Oe]=process.versions.node.split(".").map(Number);if(Oe<18)throw new Error("Logstyx SDK requires Node.js version 18 or higher. Please upgrade your Node.js runtime.");module.exports=e=>{let t;t={type:"node",origin:null,os:ee.type(),platform:ee.platform(),browser:null,screen:null};let s=Ie(P(m({},e),{device:t,signatureFunc:ke}));if((e==null?void 0:e.captureUncaught)===!0)try{typeof process!="undefined"&&typeof window=="undefined"&&process.on("uncaughtException",a=>s.critical({title:(a==null?void 0:a.name)||"Unknown Error",message:a==null?void 0:a.message,stack:(a==null?void 0:a.stack)||null}))}catch(a){console.error(a)}if((e==null?void 0:e.captureUnhandledRejections)===!0)try{let a=o=>{let l=o instanceof Error?o.message:String(o),n=o instanceof Error?o.stack:void 0,r=o instanceof Error?o.name:"Unhandled Rejection";s.critical({title:r,message:l,stack:n})};process.on("unhandledRejection",a)}catch(a){console.error(a)}return(e==null?void 0:e.autoInstrument)===!0&&Ae(s,{captureHeaders:e.captureHeaders,captureBody:e.captureBody,ignorePaths:e.ignorePaths,slowRequestThreshold:e.slowRequestThreshold,redactFields:e.redactFields,buildRequestPayload:e.buildRequestPayload,contextHook:e.contextHook}),s};module.exports.setupAutoInstrumentation=Ce;module.exports.updateConfig=Se;
